<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Paris 3D - B√¢timents annot√©s</title>

  <!-- CesiumJS depuis le CDN -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #hoverInfo {
      position: absolute;
      pointer-events: none;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      max-width: 260px;
      display: none;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="hoverInfo"></div>

  <script type="module">
    // üîë Ton token Cesium ion
    Cesium.Ion.defaultAccessToken =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyMzI2ZTg2Ny0zZjZlLTQ1ZGMtYmQ1ZS0zOGI3MTU0NGRjYjYiLCJpZCI6MzYwMDE0LCJpYXQiOjE3NjMwMjc5Njd9.oneA95UdUxZN2hOvSfc8T5vO7C7YMFnFsucSyyj4ooQ';

    // --- Cr√©ation du viewer ---
    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      timeline: false,
      animation: false,
      geocoder: true,          // ‚úÖ barre de recherche
      homeButton: false,
      sceneModePicker: false,
      baseLayerPicker: true,
      navigationHelpButton: false,
      infoBox: false,
      selectionIndicator: false
    });

    // --- B√¢timents OSM 3D ---
    const osmBuildings = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(osmBuildings);

    // Vue de d√©part : Paris
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(2.3522, 48.8566, 1500),
      orientation: {
        heading: Cesium.Math.toRadians(0.0),
        pitch: Cesium.Math.toRadians(-35.0),
        roll: 0.0
      },
      duration: 2.5
    });

    // --- Point rouge pour la recherche ---
    const searchMarker = viewer.entities.add({
      name: "R√©sultat de recherche",
      show: false,
      position: Cesium.Cartesian3.fromDegrees(0, 0, 0),
      point: {
        pixelSize: 14,
        color: Cesium.Color.RED,
        outlineColor: Cesium.Color.WHITE,
        outlineWidth: 2,
        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
      }
    });

    // On garde en m√©moire le dernier b√¢timent surlign√©
    let lastHighlightedFeature = null;

    // ‚úÖ Colorer le b√¢timent situ√© AU CENTRE de l'√©cran
    function highlightBuildingUnderCenter() {
      const scene = viewer.scene;
      const canvas = scene.canvas;

      const center = new Cesium.Cartesian2(
        canvas.clientWidth / 2,
        canvas.clientHeight / 2
      );

      const picked = scene.pick(center);

      if (!Cesium.defined(picked) || !(picked instanceof Cesium.Cesium3DTileFeature)) {
        return;
      }

      const feature = picked;

      // Remet l'ancien b√¢timent en blanc
      if (lastHighlightedFeature) {
        lastHighlightedFeature.color = Cesium.Color.WHITE;
      }

      // Colore le nouveau b√¢timent en ROUGE
      feature.color = Cesium.Color.RED.withAlpha(0.9);
      lastHighlightedFeature = feature;
    }

    // --- Branche la logique sur la barre de recherche ---
    const geocoderViewModel = viewer.geocoder.viewModel;

    geocoderViewModel.destinationFound = function (viewModel, destination) {
      let position = null;

      if (destination instanceof Cesium.Cartesian3) {
        position = destination;
      } else if (destination instanceof Cesium.Rectangle) {
        const centerCarto = Cesium.Rectangle.center(destination);
        position = Cesium.Cartesian3.fromRadians(
          centerCarto.longitude,
          centerCarto.latitude,
          0.0
        );
      }

      if (position) {
        // Place / d√©place le point rouge
        searchMarker.position = position;
        searchMarker.show = true;
      }

      // On vole vers la destination puis on surligne le b√¢timent au centre
      viewer.camera.flyTo({
        destination: destination,
        complete: function () {
          highlightBuildingUnderCenter();
        }
      });
    };

    // --- Tes points GeoJSON persos (batiments.geojson) ---
    const dataSource = await Cesium.GeoJsonDataSource.load("batiments.geojson", {
      clampToGround: true
    });
    viewer.dataSources.add(dataSource);

    const entities = dataSource.entities.values;
    for (let i = 0; i < entities.length; i++) {
      const entity = entities[i];

      // Points ORANGE pour tes b√¢timents annot√©s
      entity.point = new Cesium.PointGraphics({
        pixelSize: 12,
        color: Cesium.Color.ORANGE,
        outlineColor: Cesium.Color.WHITE,
        outlineWidth: 2
      });

      if (entity.properties && entity.properties.nom) {
        entity.label = new Cesium.LabelGraphics({
          text: entity.properties.nom,
          font: "14px sans-serif",
          fillColor: Cesium.Color.WHITE,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          pixelOffset: new Cesium.Cartesian2(0, -18),
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          disableDepthTestDistance: Number.POSITIVE_INFINITY
        });
      }
    }

    // --- Tooltip au survol pour TES entit√©s GeoJSON ---
    const hoverInfo = document.getElementById("hoverInfo");
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    handler.setInputAction(function (movement) {
      const picked = viewer.scene.pick(movement.endPosition);

      if (Cesium.defined(picked) && picked.id && picked.id.properties) {
        const props = picked.id.properties;

        const nom =
          (props.nom && props.nom.getValue()) ||
          picked.id.name ||
          "B√¢timent";

        const description =
          (props.description && props.description.getValue()) ||
          "";

        hoverInfo.style.display = "block";
        hoverInfo.style.left = movement.endPosition.x + 15 + "px";
        hoverInfo.style.top = movement.endPosition.y + 15 + "px";
        hoverInfo.innerHTML =
          "<strong>" +
          nom +
          "</strong>" +
          (description ? "<br>" + description : "");
      } else {
        hoverInfo.style.display = "none";
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
  </script>
</body>
</html>
