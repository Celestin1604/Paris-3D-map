<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Paris 3D - B√¢timents annot√©s</title>

  <!-- CesiumJS depuis le CDN -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    #hoverInfo {
      position: absolute;
      pointer-events: none;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      max-width: 260px;
      display: none;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    /* Panneau rouge / bleu */
    #selectionPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 20;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      max-width: 260px;
      font-size: 13px;
    }

    #selectionPanel h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    #selectionPanel p {
      margin: 0 0 8px;
      line-height: 1.3;
    }

    #selectionPanel button {
      margin-right: 4px;
      margin-bottom: 6px;
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }

    #addRedBtn {
      background: #e53935;
      color: #fff;
    }

    #addBlueBtn {
      background: #1e88e5;
      color: #fff;
    }

    #selectionPanel h4 {
      margin: 6px 0 2px;
      font-size: 13px;
    }

    #selectionPanel ul {
      list-style: none;
      padding-left: 10px;
      margin: 0 0 4px;
      max-height: 90px;
      overflow-y: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <!-- Panneau de s√©lection rouge / bleu -->
  <div id="selectionPanel">
    <h3>S√©l√©ctions</h3>
    <p style="margin-bottom:4px;">
      1. Fais une recherche (barre en haut √† droite).<br />
      2. Quand la cam√©ra est en place, clique sur :
    </p>
    <button id="addRedBtn">Ajouter en ROUGE</button>
    <button id="addBlueBtn">Ajouter en BLEU</button>

    <h4>Rouge</h4>
    <ul id="redList"></ul>

    <h4>Bleu</h4>
    <ul id="blueList"></ul>
  </div>

  <div id="hoverInfo"></div>

  <script type="module">
    // üîë Ton token Cesium ion
    Cesium.Ion.defaultAccessToken =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyMzI2ZTg2Ny0zZjZlLTQ1ZGMtYmQ1ZS0zOGI3MTU0NGRjYjYiLCJpZCI6MzYwMDE0LCJpYXQiOjE3NjMwMjc5Njd9.oneA95UdUxZN2hOvSfc8T5vO7C7YMFnFsucSyyj4ooQ';

    // --- Cr√©ation du viewer ---
    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      imageryProvider: false,   // pas de fond par d√©faut
      timeline: false,
      animation: false,
      geocoder: true,          // ‚úÖ barre de recherche
      homeButton: false,
      sceneModePicker: false,
      baseLayerPicker: false,
      navigationHelpButton: false,
      infoBox: false,
      selectionIndicator: false
    });

    // --- Fond de carte type OSM clair / d√©satur√© ---
    viewer.imageryLayers.removeAll();
    const osmLayer = viewer.imageryLayers.addImageryProvider(
      new Cesium.OpenStreetMapImageryProvider({
        url: "https://a.tile.openstreetmap.org/"
      })
    );
    osmLayer.saturation = 0.0;   // noir et blanc
    osmLayer.brightness = 1.1;   // un peu plus lumineux
    osmLayer.contrast = 1.05;    // l√©ger contraste

    // --- B√¢timents OSM 3D ---
    const osmBuildings = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(osmBuildings);

    // Style g√©n√©ral des b√¢timents fa√ßon maquette (blanc cass√©)
    osmBuildings.style = new Cesium.Cesium3DTileStyle({
      color: "color('white', 0.9)"
    });

    // Vue de d√©part : Paris
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(2.3522, 48.8566, 1500),
      orientation: {
        heading: Cesium.Math.toRadians(0.0),
        pitch: Cesium.Math.toRadians(-35.0),
        roll: 0.0
      },
      duration: 2.5
    });

    // --- Point rouge pour la recherche ---
    const searchMarker = viewer.entities.add({
      name: "R√©sultat de recherche",
      show: false,
      position: Cesium.Cartesian3.fromDegrees(0, 0, 0),
      point: {
        pixelSize: 14,
        color: Cesium.Color.RED,
        outlineColor: Cesium.Color.WHITE,
        outlineWidth: 2,
        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
      }
    });

    // === Gestion des b√¢timents s√©lectionn√©s ===
    let currentFeature = null;          // b√¢timent de la recherche courante
    let currentLabel = "";             // texte tap√© dans la barre de recherche
    const redFeatures = new Set();     // b√¢timents rouges
    const blueFeatures = new Set();    // b√¢timents bleus

    const redListEl = document.getElementById("redList");
    const blueListEl = document.getElementById("blueList");

    function addListItem(listEl, label, color) {
      const li = document.createElement("li");
      li.textContent = label || "(adresse sans nom)";
      li.style.color = color;
      listEl.appendChild(li);
    }

    // R√©cup√®re le b√¢timent sous le centre de l'√©cran
    function pickBuildingUnderCenter() {
      const scene = viewer.scene;
      const canvas = scene.canvas;

      const center = new Cesium.Cartesian2(
        canvas.clientWidth / 2,
        canvas.clientHeight / 2
      );

      const picks = scene.drillPick(center);
      if (!Cesium.defined(picks) || picks.length === 0) {
        return null;
      }

      for (let i = 0; i < picks.length; i++) {
        const p = picks[i];
        if (
          p instanceof Cesium.Cesium3DTileFeature &&
          p.primitive === osmBuildings
        ) {
          return p;
        }
      }
      return null;
    }

    // --- Branche la logique sur la barre de recherche ---
    const geocoderViewModel = viewer.geocoder.viewModel;

    geocoderViewModel.destinationFound = function (viewModel, destination) {
      let position = null;

      if (destination instanceof Cesium.Cartesian3) {
        position = destination;
      } else if (destination instanceof Cesium.Rectangle) {
        const centerCarto = Cesium.Rectangle.center(destination);
        position = Cesium.Cartesian3.fromRadians(
          centerCarto.longitude,
          centerCarto.latitude,
          0.0
        );
      }

      if (position) {
        // Place / d√©place le point rouge
        searchMarker.position = position;
        searchMarker.show = true;
      }

      // On vole vers la destination puis on m√©morise le b√¢timent au centre
      viewer.camera.flyTo({
        destination: destination,
        complete: function () {
          const feature = pickBuildingUnderCenter();
          currentFeature = feature;
          currentLabel = viewModel.searchText || "";
        }
      });
    };

    // --- Boutons "Ajouter en ROUGE" / "Ajouter en BLEU" ---
    document.getElementById("addRedBtn").addEventListener("click", () => {
      if (!currentFeature) {
        return;
      }

      // Si le b√¢timent √©tait bleu, on l'enl√®ve du set bleu
      if (blueFeatures.has(currentFeature)) {
        blueFeatures.delete(currentFeature);
      }

      // Met en rouge
      currentFeature.color = Cesium.Color.RED.withAlpha(0.9);
      redFeatures.add(currentFeature);

      addListItem(redListEl, currentLabel, "#e53935");
    });

    document.getElementById("addBlueBtn").addEventListener("click", () => {
      if (!currentFeature) {
        return;
      }

      // S'il √©tait rouge, on l'enl√®ve du set rouge
      if (redFeatures.has(currentF
