<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Paris 3D - B√¢timents annot√©s</title>

  <!-- CesiumJS depuis le CDN -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    #hoverInfo {
      position: absolute;
      pointer-events: none;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      max-width: 260px;
      display: none;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="hoverInfo"></div>

  <script type="module">
    // üîë Ton token Cesium ion
    Cesium.Ion.defaultAccessToken =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyMzI2ZTg2Ny0zZjZlLTQ1ZGMtYmQ1ZS0zOGI3MTU0NGRjYjYiLCJpZCI6MzYwMDE0LCJpYXQiOjE3NjMwMjc5Njd9.oneA95UdUxZN2hOvSfc8T5vO7C7YMFnFsucSyyj4ooQ';

    // --- Cr√©ation du viewer ---
    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      imageryProvider: false,   // pas de fond par d√©faut
      timeline: false,
      animation: false,
      geocoder: true,           // ‚úÖ barre de recherche
      homeButton: false,
      sceneModePicker: false,
      baseLayerPicker: false,
      navigationHelpButton: false,
      infoBox: false,
      selectionIndicator: false
    });

    // Anti-aliasing pour un rendu plus propre
    viewer.scene.postProcessStages.fxaa.enabled = true;

    // --- Fond de carte sans labels (Carto Positron no labels) ---
    viewer.imageryLayers.removeAll();
    const baseLayer = viewer.imageryLayers.addImageryProvider(
      new Cesium.UrlTemplateImageryProvider({
        url:
          "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png",
        subdomains: ["a", "b", "c", "d"]
      })
    );
    baseLayer.brightness = 1.05;
    baseLayer.saturation = 0.0; // quasi noir & blanc
    baseLayer.contrast = 1.0;

    // --- B√¢timents OSM 3D ---
    const osmBuildings = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(osmBuildings);

    // Plus de d√©tail m√™me sans zoom extr√™me
    osmBuildings.maximumScreenSpaceError = 2.0;

    // Style g√©n√©ral des b√¢timents fa√ßon maquette (blanc cass√© opaque)
    const baseBuildingColor = Cesium.Color.fromCssColorString("#f5f5f5");
    osmBuildings.style = new Cesium.Cesium3DTileStyle({
      color: "color('#f5f5f5')"
    });

    // Vue de d√©part : un peu au-dessus de Paris, angle 3D
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(2.35, 48.86, 4500),
      orientation: {
        heading: Cesium.Math.toRadians(-20.0),
        pitch: Cesium.Math.toRadians(-40.0),
        roll: 0.0
      }
    });

    // --- Point rouge pour la recherche ---
    const searchMarker = viewer.entities.add({
      name: "R√©sultat de recherche",
      show: false,
      position: Cesium.Cartesian3.fromDegrees(0, 0, 0),
      point: {
        pixelSize: 14,
        color: Cesium.Color.RED,
        outlineColor: Cesium.Color.WHITE,
        outlineWidth: 2,
        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
      }
    });

    // On garde en m√©moire le dernier b√¢timent surlign√©
    let lastHighlightedFeature = null;

    // ‚úÖ Colorer le b√¢timent situ√© AU CENTRE de l'√©cran
    function highlightBuildingUnderCenter() {
      const scene = viewer.scene;
      const canvas = scene.canvas;

      const center = new Cesium.Cartesian2(
        canvas.clientWidth / 2,
        canvas.clientHeight / 2
      );

      // Tous les objets sous le centre
      const picks = scene.drillPick(center);

      if (!Cesium.defined(picks) || picks.length === 0) {
        return;
      }

      let feature = null;

      for (let i = 0; i < picks.length; i++) {
        const p = picks[i];

        if (
          p instanceof Cesium.Cesium3DTileFeature &&
          p.primitive === osmBuildings
        ) {
          feature = p;
          break;
        }
      }

      if (!feature) {
        return;
      }

      // Remet l'ancien b√¢timent en couleur de base
      if (lastHighlightedFeature) {
        lastHighlightedFeature.color = baseBuildingColor;
      }

      // Colore le nouveau b√¢timent en rouge
      feature.color = Cesium.Color.RED;
      lastHighlightedFeature = feature;
    }

    // --- Barre de recherche : d√©placement + highlight ---
    const geocoderViewModel = viewer.geocoder.viewModel;

    geocoderViewModel.destinationFound = function (viewModel, destination) {
      let position = null;

      if (destination instanceof Cesium.Cartesian3) {
        position = destination;
      } else if (destination instanceof Cesium.Rectangle) {
        const centerCarto = Cesium.Rectangle.center(destination);
        position = Cesium.Cartesian3.fromRadians(
          centerCarto.longitude,
          centerCarto.latitude,
          0.0
        );
      }

      if (position) {
        searchMarker.position = position;
        searchMarker.show = true;
      }

      viewer.camera.flyTo({
        destination: destination,
        complete: function () {
          highlightBuildingUnderCenter();
        }
      });
    };

    // --- Tes points GeoJSON persos (batiments.geojson) ---
    const dataSource = await Cesium.GeoJsonDataSource.load("batiments.geojson", {
      clampToGround: true
    });
    viewer.dataSources.add(dataSource);

    const entities = dataSource.entities.values;
    for (let i = 0; i < entities.length; i++) {
      const entity = entities[i];

      entity.point = new Cesium.PointGraphics({
        pixelSize: 12,
        color: Cesium.Color.ORANGE,
        outlineColor: Cesium.Color.WHITE,
        outlineWidth: 2
      });

      if (entity.properties && entity.properties.nom) {
        entity.label = new Cesium.LabelGraphics({
          text: entity.properties.nom,
          font: "14px sans-serif",
          fillColor: Cesium.Color.WHITE,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          pixelOffset: new Cesium.Cartesian2(0, -18),
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          disableDepthTestDistance: Number.POSITIVE_INFINITY
        });
      }
    }

    // --- Tooltip au survol pour TES entit√©s GeoJSON ---
    const hoverInfo = document.getElementById("hoverInfo");
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    handler.setInputAction(function (movement) {
      const picked = viewer.scene.pick(movement.endPosition);

      if (Cesium.defined(picked) && picked.id && picked.id.properties) {
        const props = picked.id.properties;

        const nom =
          (props.nom && props.nom.getValue()) ||
          picked.id.name ||
          "B√¢timent";

        const description =
          (props.description && props.description.getValue()) ||
          "";

        hoverInfo.style.display = "block";
        hoverInfo.style.left = movement.endPosition.x + 15 + "px";
        hoverInfo.style.top = movement.endPosition.y + 15 + "px";
        hoverInfo.innerHTML =
          "<strong>" +
          nom +
          "</strong>" +
          (description ? "<br>" + description : "");
      } else {
        hoverInfo.style.display = "none";
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
  </script>
</body>
</html>
